name: Pre-commit Checks

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master, develop]
  workflow_dispatch:

jobs:
  pre-commit-checks:
    name: Run Pre-commit Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for branch comparison

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Install pre-commit hooks
        run: pre-commit install --install-hooks

      - name: Run pre-commit on all files
        run: pre-commit run --all-files

      - name: Check branch naming (for PRs)
        if: github.event_name == 'pull_request'
        run: |
          branch_name="${{ github.head_ref }}"
          if [[ ! "$branch_name" =~ ^(feature/|fix/|docs/|chore/|refactor/|test/).*$ ]]; then
            echo "❌ Branch name must start with: feature/, fix/, docs/, chore/, refactor/, or test/"
            echo "Current branch: $branch_name"
            exit 1
          fi
          echo "✅ Branch name follows convention: $branch_name"

      - name: Check commit message format (for PRs)
        if: github.event_name == 'pull_request'
        run: |
          # Get commits in PR
          commits=$(git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          echo "$commits" | while IFS= read -r commit_msg; do
            if [[ ! "$commit_msg" =~ ^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+$ ]]; then
              echo "❌ Commit message does not follow Conventional Commits format:"
              echo "   $commit_msg"
              echo ""
              echo "Format: <type>(<scope>): <subject>"
              echo "Types: feat, fix, docs, style, refactor, test, chore"
              exit 1
            fi
          done
          echo "✅ All commit messages follow Conventional Commits format"

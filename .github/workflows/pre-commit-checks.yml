name: Pre-commit Checks

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master, develop]
  workflow_dispatch:

jobs:
  pre-commit-checks:
    name: Run Pre-commit Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for branch comparison

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Install pre-commit hooks
        run: pre-commit install --install-hooks

      - name: Run pre-commit on all files
        run: |
          pre-commit run --all-files || echo "⚠️ Some pre-commit checks failed"
        continue-on-error: true

      - name: Validate PR naming + issue linking (for PRs)
        if: github.event_name == 'pull_request'
        run: |
          python - <<'PY'
          import json
          import os
          import subprocess
          import sys
          
          with open(os.environ["GITHUB_EVENT_PATH"], "r", encoding="utf-8") as f:
              event = json.load(f)
          
          pr = event.get("pull_request") or {}
          head = pr.get("head") or {}
          
          branch = head.get("ref") or ""
          title = pr.get("title") or ""
          body = pr.get("body") or ""
          actor = os.environ.get("GITHUB_ACTOR", "")
          
          subprocess.run([sys.executable, "scripts/conventions.py", "check-branch", "--branch", branch], check=True)
          subprocess.run([sys.executable, "scripts/conventions.py", "check-pr-title", "--title", title], check=True)
          subprocess.run(
              [sys.executable, "scripts/conventions.py", "check-pr-body", "--branch", branch, "--actor", actor],
              input=body,
              text=True,
              check=True,
          )
          
          print(f"✅ PR conventions OK (branch={branch})")
          PY

      - name: Check commit message format (for PRs)
        if: github.event_name == 'pull_request'
        run: |
          branch_name="${{ github.head_ref }}"
          actor="${{ github.actor }}"
          
          # Don't enforce Conventional Commits for bot PRs.
          if [[ "$actor" == "dependabot[bot]" || "$actor" == "renovate[bot]" || "$branch_name" == dependabot/* || "$branch_name" == renovate/* ]]; then
            echo "✅ Skipping commit message check for bot PR ($actor, $branch_name)"
            exit 0
          fi
          
          # Get commits in PR
          base_sha="${{ github.event.pull_request.base.sha }}"
          head_sha="${{ github.event.pull_request.head.sha }}"
          
          if [ -z "$base_sha" ] || [ -z "$head_sha" ]; then
            echo "⚠️ Could not determine commit range, skipping commit message check"
            exit 0
          fi
          
          commits=$(git log --format=%s "$base_sha".."$head_sha" 2>/dev/null || echo "")
          if [ -z "$commits" ]; then
            echo "⚠️ No commits found in PR range, skipping commit message check"
            exit 0
          fi
          
          failed=0
          while IFS= read -r commit_msg; do
            if [ -z "$commit_msg" ]; then
              continue
            fi
            python scripts/conventions.py check-commit-subject --subject "$commit_msg" >/dev/null || failed=1
          done <<< "$commits"
          
          if [ $failed -eq 0 ]; then
            echo "✅ All commit messages follow Conventional Commits format"
            exit 0
          fi
          
          echo "❌ Some commit messages do not follow Conventional Commits format"
          exit 1
